// === loadMap() — FINAL: DENSE CAP ONLY FOR TRUE DENSE NORTHEAST (NE) ===
async function loadMap(appNumber, network, fna_member = null) {
    const mapDiv = document.getElementById('map-container');

    // DESTROY OLD MAP COMPLETELY
    if (mapDiv._leaflet_map) {
        mapDiv._leaflet_map.remove();
        mapDiv._leaflet_map = null;
    }
    mapDiv.innerHTML = '';

    let url = `/erate/bbmap/${appNumber}?network=${network}`;
    if (fna_member) url += `&fna_member=${encodeURIComponent(fna_member)}`;

    const resp = await fetch(url);
    const data = await resp.json();
    if (data.error) throw new Error(data.error);

    // CREATE MAP WITH CANVAS RENDERER
    const map = L.map('map-container', {
        renderer: L.canvas()
    });
    mapDiv._leaflet_map = map;

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap | ' + (
            network === 'fna' ? 'FNA Network' :
            network === 'segra_east' ? 'Segra East' :
            network === 'segra_west' ? 'Segra West' :
            network === 'fidium' ? 'Fidium Network' :
            'Bluebird Network'
        )
    }).addTo(map);

    const fiberColor = network === 'fna' ? '#dc3545' : '#9932CC';
    const fiberWeight = network === 'fna' ? 4 : 2;
    const fiberOpacity = network === 'fna' ? 0.9 : 0.7;

    let routeCount = 0;

    // === DETECT DENSE NORTHEAST BY ROUTE COUNT (RELIABLE) ===
    let isDenseNortheast = false;
    if (network === 'fidium' && data.routes) {
        const totalRoutes = data.routes.length;
        if (totalRoutes > 150000) {  // NE ~285k, SO/MW/WE <50k — safe threshold
            isDenseNortheast = true;
            console.log(`Detected dense Northeast (${totalRoutes} routes) — capping enabled`);
        } else {
            console.log(`Non-dense Fidium (${totalRoutes} routes) — full load`);
        }
    }

    const MAX_ROUTES = isDenseNortheast ? 50000 : 100000;

    // === ROUTES ===
    if (data.routes && data.routes.length > 0) {
        data.routes.forEach(r => {
            if (r.coords && r.coords.length > 1) {
                if (isDenseNortheast && routeCount >= MAX_ROUTES) {
                    return;
                }

                L.polyline(r.coords, {
                    color: fiberColor,
                    weight: fiberWeight,
                    opacity: fiberOpacity,
                    noClip: true,
                    smoothFactor: 1
                }).addTo(map);

                routeCount++;
            }
        });
    }

    // === PoPs ===
    if (data.pops && data.pops.length > 0) {
        data.pops.forEach(p => {
            L.circleMarker([p.lat, p.lon], {
                radius: 6,
                color: network === 'fna' ? '#dc3545' : '#28a745',
                fillOpacity: 0.8
            }).bindPopup(`<strong>${p.name}</strong>`).addTo(map);
        });
    }

    // === Applicant Pin & Center Map ===
    let mapCentered = false;
    if (data.applicant_coords) {
        const [lat, lng] = data.applicant_coords;
        const icon = L.divIcon({
            className: '',
            html: '<div style="background:#007bff;width:16px;height:16px;border-radius:50%;border:3px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.3);"></div>',
            iconSize: [16, 16]
        }

<!DOCTYPE html>
<html>
<head>
    <title>E-Rate</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root { --primary: #1a5d57; --accent: #007bff; --bg: #f4f7f9; --card: white; --border: #ddd; --text: #333; --hover: #f0f7ff; }
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); color: var(--text); min-height: 100vh; display: flex; flex-direction: column; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 9999; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .overlay.show { display: flex; }
        .spinner { width: 60px; height: 60px; border: 6px solid #f3f3f3; border-top: 6px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .container { max-width: 1000px; margin: 20px auto; background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); flex: 1; }
        .header { background: var(--primary); color: white; padding: 1rem; text-align: center; position: relative; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; justify-content: center; align-items: center; }
        .header h1 { margin: 0; font-size: 1.8rem; font-weight: 600; }
        .user-info { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); font-size: 0.9rem; font-weight: 600; color: #fff; text-decoration: none; }
        .user-info:hover { text-decoration: underline; }
        .points { margin-left: 6px; font-size: 0.8rem; opacity: 0.9; font-weight: 400; transition: color 0.3s; }
        .logout { position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); color: white; text-decoration: none; font-size: 0.9rem; font-weight: 600; }
        .logout:hover { text-decoration: underline; }
        .filters { display: flex; gap: 10px; margin: 20px 0; flex-wrap: wrap; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef; }
        .filters label { font-weight: 600; color: var(--primary); display: flex; align-items: center; gap: 6px; white-space: nowrap; font-size: 0.9rem; }
        .filters input[type="text"], .filters input[type="date"] { padding: 8px 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.9rem; min-width: 80px; }
        .filters input[type="text"] { width: 50px; text-transform: uppercase; }
        .filters input[name="text"] { width: 120px; text-transform: none; }
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85rem; transition: all 0.2s; text-align: center; display: block; width: 100%; margin: 4px 0; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; width: auto; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .summary { font-weight: 600; color: var(--primary); margin: 15px 0; font-size: 1rem; text-align: center; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9rem; }
        th, td { border: 1px solid var(--border); padding: 10px 8px; text-align: left; vertical-align: middle; }
        th { background: var(--primary); color: white; font-weight: 600; position: sticky; top: 0; z-index: 10; font-size: 0.85rem; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        tr:hover { background-color: var(--hover); }
        .app-number { font-family: monospace; font-weight: 600; color: var(--accent); text-decoration: underline; cursor: pointer; font-size: 0.9rem; }
        .app-number:hover { color: #0056b3; }
        .entity-name { cursor: pointer; color: var(--accent); text-decoration: underline; font-size: 0.9rem; }
        .entity-name:hover { color: #0056b3; }
        .modified { font-size: 0.8rem; color: #666; }
        .pagination { text-align: center; margin: 25px 0; }
        .load-more { display: inline-block; padding: 10px 25px; background: var(--accent); color: white; border-radius: 8px; font-weight: 600; text-decoration: none; font-size: 0.9rem; }
        .load-more:hover { background: #0056b3; }
        .flash { padding: 12px; margin: 15px 0; border-radius: 6px; text-align: center; font-weight: 600; font-size: 0.9rem; }
        .flash.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .flash.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal.show { display: flex; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; max-width: 700px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .modal-title { font-weight: 600; color: var(--primary); font-size: 1.3rem; }
        .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #999; }
        .modal-close:hover { color: #333; }
        .modal-body { font-size: 0.95rem; line-height: 1.6; margin-bottom: 15px; position: relative; }
        #map-container { height: 400px; width: 100%; border-radius: 8px; margin-top: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); position: relative; }
        #map-loading { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 999; display: none; justify-content: center; align-items: center; flex-direction: column; gap: 15px; font-weight: 600; color: var(--primary); }
        @media (max-width: 768px) { .container { margin: 10px; padding: 15px; } #map-container { height: 300px; } }
    </style>
</head>
<body>
    <!-- AUTH MODAL -->
    <div class="modal" id="authModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Welcome to E-Rate</div>
            </div>
            <div class="modal-body" style="text-align:center;">
                <button class="btn btn-secondary" onclick="continueAsGuest()" style="margin:8px 0;">Continue as Guest</button>
                <button class="btn btn-primary" onclick="showRegister()" style="margin:8px 0;">Register</button>
                <button class="btn btn-success" onclick="showLogin()" style="margin:8px 0;">Login</button>
            </div>
        </div>
    </div>

    <!-- MAP MODAL — THIS IS THE ONE THAT WORKS -->
    <div class="modal" id="map-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="map-title">Network + Applicant</div>
                <div style="margin-left: auto; display: flex; gap: 8px; align-items: center;">
                    <select id="network-select" class="btn btn-secondary" style="padding: 6px; font-size: 0.8rem;">
                        <option value="bluebird">Bluebird Network</option>
                        <option value="fna">FNA Network</option>
                    </select>
                    <select id="fna-member-select" style="display:none; padding:6px; font-size:0.8rem;" disabled>
                        <option>Loading members...</option>
                    </select>
                </div>
                <button class="modal-close" onclick="closeModal('map')">x</button>
            </div>
            <div class="modal-body">
                <div id="map-loading">
                    <div class="spinner"></div>
                    <div>Loading fiber routes...</div>
                </div>
                <div id="map-container"></div>
            </div>
        </div>
    </div>

    <script>
        const form = document.getElementById('filter-form');
        const overlay = document.getElementById('loading');
        const body = document.body;
        const mapModal = document.getElementById('map-modal');
        let currentAppNumber = null;
        let currentNetwork = localStorage.getItem('preferredNetwork') || 'bluebird';
        let currentFnaMember = null;

        // === openMapModal() — FINAL WORKING VERSION ===
        async function openMapModal(appNumber, dbLat, dbLon) {
            updatePoints();
            currentAppNumber = appNumber;
            body.classList.add('loading');
            overlay.classList.add('show');
            mapModal.classList.add('show');

            const mapDiv = document.getElementById('map-container');
            if (mapDiv._leaflet_map) {
                mapDiv._leaflet_map.remove();
                delete mapDiv._leaflet_map;
            }
            mapDiv.innerHTML = '';

            document.getElementById('network-select').value = currentNetwork;
            document.getElementById('network-select').dispatchEvent(new Event('change'));

            document.getElementById('map-title').textContent = 
                currentNetwork === 'fna' ? 'FNA Network + Applicant' : 'Bluebird Network + Applicant';

            body.classList.remove('loading');
            overlay.classList.remove('show');
        }

        // === NETWORK SWITCHER — FINAL WORKING VERSION ===
        document.getElementById('network-select')?.addEventListener('change', async (e) => {
            const network = e.target.value;
            currentNetwork = network;
            localStorage.setItem('preferredNetwork', network);

            const memberSelect = document.getElementById('fna-member-select');

            document.getElementById('map-title').textContent = 
                network === 'fna' ? 'FNA Network + Applicant' : 'Bluebird Network + Applicant';

            document.getElementById('map-loading').style.display = 'flex';
            document.body.style.cursor = 'wait';

            try {
                if (network === 'fna') {
                    memberSelect.style.display = 'block';
                    memberSelect.disabled = true;
                    memberSelect.innerHTML = '<option>Loading members...</option>';

                    const resp = await fetch(`/erate/bbmap/${currentAppNumber}?network=fna`);
                    const data = await resp.json();

                    if (data.fna_members?.length > 0) {
                        memberSelect.innerHTML = '<option value="">— Select Member —</option>';
                        data.fna_members.forEach(text => {
                            const clean = text.replace(/^★\s*/, '').split(' (')[0].trim();
                            const opt = new Option(text, clean);
                            memberSelect.appendChild(opt);
                        });
                        memberSelect.disabled = false;
                        currentFnaMember = memberSelect.options[1].value;
                        memberSelect.value = currentFnaMember;
                    }
                } else {
                    memberSelect.style.display = 'none';
                    currentFnaMember = null;
                }

                await loadMap(currentAppNumber, network, currentFnaMember);

            } catch (err) {
                console.error("FNA load failed:", err);
            } finally {
                document.getElementById('map-loading').style.display = 'none';
                document.body.style.cursor = 'default';
            }
        });

        // === FNA MEMBER CHANGE ===
        document.getElementById('fna-member-select')?.addEventListener('change', async (e) => {
            currentFnaMember = e.target.value;
            if (currentFnaMember && currentAppNumber) {
                document.getElementById('map-loading').style.display = 'flex';
                document.body.style.cursor = 'wait';
                await loadMap(currentAppNumber, 'fna', currentFnaMember);
                document.getElementById('map-loading').style.display = 'none';
                document.body.style.cursor = 'default';
            }
        });

        // === loadMap() — YOUR WORKING VERSION FROM YESTERDAY (with FNA colors) ===
        async function loadMap(appNumber, network, fna_member = null) {
            let url = `/erate/bbmap/${appNumber}?network=${network}`;
            if (fna_member) url += `&fna_member=${encodeURIComponent(fna_member)}`;

            const resp = await fetch(url);
            const data = await resp.json();
            if (data.error) throw new Error(data.error);

            const map = L.map('map-container').setView([39.8, -92.5], 7);
            document.getElementById('map-container')._leaflet_map = map;

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap | ' + (network === 'fna' ? `FNA - ${fna_member || ''}` : 'Bluebird Fiber')
            }).addTo(map);

            // Routes — red and thick for FNA
            data.routes?.forEach(r => {
                if (r.coords?.length > 1) {
                    L.polyline(r.coords, {
                        color: network === 'fna' ? '#dc3545' : '#007bff',
                        weight: network === 'fna' ? 4 : 3,
                        opacity: network === 'fna' ? 0.9 : 0.7
                    }).addTo(map);
                }
            });

            // PoPs
            data.pops?.forEach(p => {
                L.circleMarker([p.lat, p.lon], {
                    radius: 6,
                    color: network === 'fna' ? '#dc3545' : '#28a745',
                    fillOpacity: 0.8
                }).bindPopup(`<strong>${p.name}</strong>`).addTo(map);
            });

            // Applicant pin and zoom
            if (data.applicant_coords) {
                const [lat, lng] = data.applicant_coords;
                L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: '', html: '<div style="background:#007bff;width:16px;height:16px;border-radius:50%;border:3px solid white;"></div>', iconSize: [16,16]
                    })
                }).bindPopup(`<strong>${data.entity_name}</strong><br>${data.address}`).addTo(map);
                map.setView([lat, lng], 12);
            }
        }
    </script>
</body>
</html>

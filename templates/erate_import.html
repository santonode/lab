<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Rate Interactive Import</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 900px; margin: auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #263238; }
        .progress { background: #eee; border-radius: 10px; height: 30px; margin: 20px 0; overflow: hidden; }
        .progress-bar { height: 100%; background: #26A69A; width: 0%; transition: width 0.5s; text-align: center; color: white; line-height: 30px; font-weight: bold; }
        .stats { display: flex; justify-content: space-around; margin: 15px 0; font-size: 18px; }
        .stats span { padding: 8px 15px; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .row-data { background: #f9f9f9; padding: 20px; border-radius: 8px; margin: 20px 0; }
        .field { margin: 8px 0; }
        .field strong { display: inline-block; width: 180px; color: #555; }
        .actions { text-align: center; margin: 25px 0; }
        .btn { padding: 12px 25px; margin: 0 10px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn:hover { opacity: 0.9; }
        .loading { display: none; text-align: center; margin: 20px; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .complete { text-align: center; padding: 40px; }
        .complete h2 { color: #28a745; }
    </style>
</head>
<body>
    <div class="container">
        <h1>E-Rate 470 Import Tool</h1>

        <div class="progress">
            <div class="progress-bar" id="progressBar">0%</div>
        </div>

        <div class="stats">
            <span class="success">Success: <strong id="successCount">{{ progress.success }}</strong></span>
            <span class="error">Errors: <strong id="errorCount">{{ progress.error }}</strong></span>
            <span>Row: <strong>{{ progress.index }}</strong> / {{ progress.total }}</span>
        </div>

        {% if progress.index > progress.total %}
            <div class="complete">
                <h2>Import Complete!</h2>
                <p><strong>{{ progress.success }}</strong> records imported successfully.</p>
                <p><strong>{{ progress.error }}</strong> records skipped or failed.</p>
                <a href="{{ url_for('erate.import_complete') }}" class="btn btn-success">View Summary</a>
            </div>
        {% else %}
            <div class="row-data">
                <h3>Current Record (Row {{ progress.index }})</h3>
                <div class="field"><strong>FRN:</strong> {{ row.FRN|default('N/A') }}</div>
                <div class="field"><strong>Applicant:</strong> {{ row['Applicant Name']|default('N/A') }}</div>
                <div class="field"><strong>BEN:</strong> {{ row.BEN|default('N/A') }}</div>
                <div class="field"><strong>City/State:</strong> {{ row.City|default('') }}, {{ row.State|default('') }}</div>
                <div class="field"><strong>Zip:</strong> {{ row['Zip Code']|default('N/A') }}</div>
                <div class="field"><strong>Contact:</strong> {{ row['Contact Name']|default('N/A') }}</div>
                <div class="field"><strong>Phone:</strong> {{ row['Contact Phone']|default('N/A') }}</div>
                <div class="field"><strong>Email:</strong> {{ row['Contact Email']|default('N/A') }}</div>
                <div class="field"><strong>Category:</strong> {{ row.Category|default('N/A') }}</div>
                <div class="field"><strong>Discount:</strong> {{ row['Discount Level']|default('N/A') }}</div>
                <div class="field"><strong>Service:</strong> {{ row['Service Type']|default('N/A') }}</div>
            </div>

            <div class="actions">
                <button onclick="importOne()" class="btn btn-primary">Import This Row</button>
                <button onclick="importAll()" class="btn btn-success">Import All Remaining</button>
                <button onclick="resetImport()" class="btn btn-danger">Reset & Start Over</button>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Importing... Please wait.</p>
            </div>
        {% endif %}
    </div>

    <script>
        function updateProgress(success, error, index, total) {
            const percent = total > 0 ? (index / total) * 100 : 0;
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressBar').textContent = Math.round(percent) + '%';
            document.getElementById('successCount').textContent = success;
            document.getElementById('errorCount').textContent = error;
        }

        function importOne() {
            const btn = event.target;
            btn.disabled = true;
            document.getElementById('loading').style.display = 'block';

            fetch('{{ url_for("erate.import_interactive") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'action=import_one'
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    updateProgress(data.success_count, data.error_count, data.index, data.total);
                    if (data.index > data.total) {
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        location.reload();
                    }
                } else {
                    alert('Error: ' + data.message);
                    btn.disabled = false;
                }
            })
            .catch(() => {
                alert('Network error');
                btn.disabled = false;
            })
            .finally(() => {
                document.getElementById('loading').style.display = 'none';
            });
        }

        function importAll() {
            if (!confirm('Import ALL remaining rows? This cannot be stopped.')) return;

            const btn = event.target;
            btn.disabled = true;
            document.getElementById('loading').style.display = 'block';

            fetch('{{ url_for("erate.import_interactive") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'action=import_all'
            })
            .then(r => r.json())
            .then(data => {
                if (data.complete) {
                    updateProgress(data.progress.success, data.progress.error, data.progress.index, data.progress.total);
                    setTimeout(() => location.href = '{{ url_for("erate.import_complete") }}', 1500);
                }
            })
            .catch(() => alert('Error during bulk import'))
            .finally(() => {
                document.getElementById('loading').style.display = 'none';
            });
        }

        function resetImport() {
            if (confirm('Reset import and start over? All progress will be lost.')) {
                fetch('{{ url_for("erate.import_interactive") }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: 'action=reset'
                }).then(() => location.reload());
            }
        }

        // Initial progress
        updateProgress({{ progress.success }}, {{ progress.error }}, {{ progress.index }}, {{ progress.total }});
    </script>
</body>
</html>

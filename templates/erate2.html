<!DOCTYPE html>
<html>
<head>
    <title>E-Rate 471 Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --primary: #1a5d57;
            --accent: #007bff;
            --bg: #f4f7f9;
            --card: white;
            --border: #ddd;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 10px; }
        .container { max-width: 1200px; margin: auto; background: var(--card); padding: 15px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: black; font-size: 1.4rem; margin: 10px 0; }
        .filters { text-align: center; margin: 15px 0; }
        .filters label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 1rem; }
        .filters input { padding: 10px; width: 100%; max-width: 250px; border: 1px solid var(--border); border-radius: 6px; }
        .filters .btn-group { margin-top: 10px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        .filters .btn { padding: 10px 20px; font-size: 1rem; }
        p[style*="text-align:center"] { font-size: 0.9rem; margin: 10px 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.85rem; }
        th, td { border: 1px solid var(--border); padding: 6px; text-align: left; }
        th { background: #6c757d; color: white; font-size: 0.8rem; }
        tr:nth-child(even) { background: #f9f9f9; }
        .app-number { color: var(--accent); cursor: pointer; text-decoration: underline; font-weight: 600; }
        .pagination { text-align: center; margin: 20px 0; }
        .btn { padding: 8px 16px; background: var(--accent); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 1000; }
        .modal.show { display: flex; }
        .modal-content { background: white; padding: 20px; border-radius: 12px; max-width: 95%; width: 95%; max-height: 90vh; overflow-y: auto; }
        .modal-close { float: right; font-size: 1.5rem; cursor: pointer; }

        /* Full-screen loading overlay */
        #page-loading-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            font-size: 1.4rem;
            color: var(--primary);
        }
        #page-loading-overlay .spinner {
            border: 10px solid #f3f3f3;
            border-top: 10px solid var(--accent);
            border-radius: 50%;
            width: 80px;
            height: 80px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
<!-- Loading overlay -->
<div id="page-loading-overlay">
    <div class="spinner"></div>
    <div>Loading 471 data... Please wait</div>
</div>

<div class="container">
    <h1>E-Rate 471 Dashboard</h1>

    <div class="filters">
        <form method="get" id="ben-search-form">
            <label>BEN #:
                <input type="text" name="ben" value="{{ filters.ben|default('') }}" placeholder="e.g. 16034746">
            </label>
            <div class="btn-group">
                <button type="submit" class="btn">Search</button>
                <a href="{{ url_for('erate.dashboard471') }}" class="btn" style="background:#6c757d;">Clear</a>
            </div>
        </form>
    </div>

    <p style="text-align:center;">Showing {{ total_filtered }} of {{ total_count }} records</p>

    <table>
        <thead>
            <tr>
                <th>App#</th>
                <th>Yr</th>
                <th>Org</th>
                <th>Stat</th>
                <th>Cat</th>
                <th>Amt</th>
            </tr>
        </thead>
        <tbody>
            {% if table_data %}
                {% for row in table_data %}
                <tr>
                    <td><span class="app-number" onclick="show471Details('{{ row.application_number }}')">{{ row.application_number }}</span></td>
                    <td>{{ row.funding_year[-2:] }}</td>
                    <td>{{ row.organization_name }}</td>
                    <td>
                        {% if row.status == 'Committed' %}Com
                        {% elif row.status == 'Certified' %}Cert
                        {% else %}{{ row.status }}{% endif %}
                    </td>
                    <td>
                        {% if row.categories_of_service == 'Category1' %}C1
                        {% elif row.categories_of_service == 'Category2' %}C2
                        {% else %}{{ row.categories_of_service }}{% endif %}
                    </td>
                    <td>
                        {% set amount = row.commitment_amount %}
                        {% if amount > 0 %}
                            {% if amount >= 1000 %}
                                ${{ "%.0f"|format(amount / 1000) }}k
                            {% else %}
                                ${{ "%.1f"|format(amount / 1000) }}k
                            {% endif %}
                        {% else %}
                            $0
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            {% else %}
                <tr><td colspan="6" style="text-align:center; padding:40px; color:#999;">No 471 records found. Try a different BEN#.</td></tr>
            {% endif %}
        </tbody>
    </table>

    <!-- Pagination -->
    {% if has_more or offset > 0 %}
    <div class="pagination">
        {% if offset > 0 %}
            <a href="?ben={{ filters.ben|default('') }}&offset={{ offset - 20 }}" class="btn">Previous</a>
        {% endif %}
        {% if has_more %}
            <a href="?ben={{ filters.ben|default('') }}&offset={{ offset + 20 }}" class="btn">Next</a>
        {% endif %}
    </div>
    {% endif %}

    <div style="text-align:center; margin-top:40px;">
        <a href="{{ url_for('erate.dashboard') }}" class="btn" style="background:#6c757d;">Back to 470 Dashboard</a>
    </div>
</div>

<!-- 471 Details Modal -->
<div class="modal" id="detail471-modal">
    <div class="modal-content">
        <span class="modal-close" onclick="document.getElementById('detail471-modal').classList.remove('show')">×</span>
        <h2>Form 471 Details</h2>
        <div id="detail471-body">Loading...</div>
    </div>
</div>

<script>

    // Hide loading overlay when page is fully loaded
    window.addEventListener('load', () => {
        document.getElementById('page-loading-overlay').style.display = 'none';
    });
    // Show overlay again on search submit
    document.getElementById('ben-search-form').addEventListener('submit', () => {
        document.getElementById('page-loading-overlay').style.display = 'flex';
    });

    async function show471Details(appNumber) {
        const modal = document.getElementById('detail471-modal');
        const body = document.getElementById('detail471-body');
        modal.classList.add('show');
        body.innerHTML = 'Loading...';
        try {
            const resp = await fetch(`/erate/erate471/details/${appNumber}`);
            if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
            const data = await resp.json();
            if (data.error) throw new Error(data.error);

            // Extracted info at the very top
            const extractedInfo = (data.service_provider !== "Not found" || data.services_end_date !== "Not found") ? `
                <div style="background:#e8f5e8; padding:15px; border-radius:8px; margin-bottom:20px; border-left:4px solid #28a745;">
                    ${data.service_provider !== "Not found" ? `<p><strong>Service Provider:</strong> ${data.service_provider}</p>` : ''}
                    ${data.services_end_date !== "Not found" ? `<p><strong>Services End Date:</strong> ${data.services_end_date}</p>` : ''}
                </div>
            ` : '';

            // PDF display
            const pdfDisplay = data.form_pdf && data.form_pdf.trim() !== ''
                ? `
                    <div style="background:#f8f9fa; padding:15px; border-radius:8px; margin-bottom:20px; border-left:4px solid var(--accent);">
                        <p><strong>Form PDF:</strong></p>
                        <p>
                            <a href="${data.form_pdf}" target="_blank" rel="noopener" style="font-weight:600; color:#007bff; text-decoration:underline;">
                                Open Original Form 471 PDF
                            </a>
                        </p>
                        <p style="word-break:break-all; font-family:monospace; font-size:0.9em; color:#666;">
                            <strong>URL:</strong> ${data.form_pdf}
                        </p>
                    </div>
                `
                : '<p><strong>Form PDF:</strong> Not available</p>';

            body.innerHTML = `
                ${extractedInfo}
                ${pdfDisplay}

                <h3>Basic Information</h3>
                <p><strong>Application #:</strong> ${data.application_number || '—'}</p>
                <p><strong>Funding Year:</strong> ${data.funding_year || '—'}</p>
                <p><strong>Form Version:</strong> ${data.form_version || '—'}</p>
                <p><strong>Window Status:</strong> ${data.window_status || '—'}</p>
                <p><strong>Nickname:</strong> ${data.nickname || '—'}</p>
                <p><strong>Status:</strong> ${data.status || '—'}</p>
                <p><strong>Category:</strong> ${data.categories_of_service || '—'}</p>

                <h3>Billed Entity / Organization</h3>
                <p><strong>Name:</strong> ${data.organization_name || '—'}</p>
                <p><strong>BEN:</strong> ${data.billed_entity_number || '—'}</p>
                <p><strong>FCC Reg #:</strong> ${data.fcc_registration_number || '—'}</p>
                <p><strong>Type:</strong> ${data.applicant_type || '—'}</p>
                <p><strong>Address Line 1:</strong> ${data.billed_entity_address1 || '—'}</p>
                <p><strong>Address Line 2:</strong> ${data.billed_entity_address2 || '—'}</p>
                <p><strong>City:</strong> ${data.billed_entity_city || '—'}</p>
                <p><strong>State:</strong> ${data.billed_entity_state || '—'}</p>
                <p><strong>Zip Code:</strong> ${data.billed_entity_zip_code || '—'} ${data.billed_entity_zip_code_ext ? '-' + data.billed_entity_zip_code_ext : ''}</p>
                <p><strong>Phone:</strong> ${data.billed_entity_phone || '—'} ${data.billed_entity_phone_ext || ''}</p>
                <p><strong>Email:</strong> ${data.billed_entity_email || '—'}</p>

                <h3>Contact Person</h3>
                <p><strong>First Name:</strong> ${data.contact_first_name || '—'}</p>
                <p><strong>Middle Initial:</strong> ${data.contact_middle_initial || '—'}</p>
                <p><strong>Last Name:</strong> ${data.contact_last_name || '—'}</p>
                <p><strong>Email:</strong> ${data.contact_email || '—'}</p>
                <p><strong>Phone:</strong> ${data.contact_phone_number || '—'} ${data.contact_phone_ext || ''}</p>

                <h3>Authorized Person</h3>
                <p><strong>First Name:</strong> ${data.authorized_first_name || '—'}</p>
                <p><strong>Middle Name:</strong> ${data.authorized_middle_name || '—'}</p>
                <p><strong>Last Name:</strong> ${data.authorized_last_name || '—'}</p>
                <p><strong>Title:</strong> ${data.authorized_title || '—'}</p>
                <p><strong>Employer:</strong> ${data.authorized_employer || '—'}</p>
                <p><strong>Address Line 1:</strong> ${data.authorized_address_line_1 || '—'}</p>
                <p><strong>Address Line 2:</strong> ${data.authorized_address_line_2 || '—'}</p>
                <p><strong>City:</strong> ${data.authorized_city || '—'}</p>
                <p><strong>State:</strong> ${data.authorized_state || '—'}</p>
                <p><strong>Zip Code:</strong> ${data.authorized_zip_code || '—'} ${data.authorized_zip_code_ext ? '-' + data.authorized_zip_code_ext : ''}</p>
                <p><strong>Phone:</strong> ${data.authorized_phone || '—'} ${data.authorized_phone_extension || ''}</p>
                <p><strong>Email:</strong> ${data.authorized_email || '—'}</p>

                <h3>Certification & Enrollment</h3>
                <p><strong>Certified Date/Time:</strong> ${data.certified_datetime || '—'}</p>
                <p><strong>Fulltime Enrollment:</strong> ${data.fulltime_enrollment || '—'}</p>
                <p><strong>NSLP Count:</strong> ${data.nslp_count || '—'}</p>
                <p><strong>NSLP Percentage:</strong> ${data.nslp_percentage || '0%'}</p>
                <p><strong>Urban/Rural Status:</strong> ${data.urban_rural_status || '—'}</p>

                <h3>Discount Rates</h3>
                <p><strong>Category One:</strong> ${data.category_one_discount_rate || '0%'}</p>
                <p><strong>Category Two:</strong> ${data.category_two_discount_rate || '0%'}</p>
                <p><strong>Voice:</strong> ${data.voice_discount_rate || '0%'}</p>

                <h3>Funding Amounts</h3>
                <p><strong>Pre-Discount Eligible:</strong> ${data.pre_discount_amount || '$0.00'}</p>
                <p><strong>Commitment Request:</strong> ${data.commitment_amount || '$0.00'}</p>
                <p><strong>Non-Discount Share:</strong> ${data.non_discount_share || '$0.00'}</p>

                <h3>Flags</h3>
                <p><strong>Funds from Service Provider:</strong> ${data.funds_from_service_provider || '—'}</p>
                <p><strong>Service Provider Filed by Billed Entity:</strong> ${data.service_provider_filed_by_billed_entity || '—'}</p>

                <h3>Dates & Location</h3>
                <p><strong>Last Updated:</strong> ${data.last_updated_datetime || '—'}</p>
                <p><strong>Latitude:</strong> ${data.latitude || '—'}</p>
                <p><strong>Longitude:</strong> ${data.longitude || '—'}</p>
            `;
        } catch (err) {
            console.error("471 Details load error:", err);
            body.innerHTML = `<p style="color:red;">Error loading details: ${err.message}</p>`;
        }
    }

    // Close modal on background click or X
    document.getElementById('detail471-modal').addEventListener('click', function(e) {
        if (e.target === this || e.target.classList.contains('modal-close')) {
            this.classList.remove('show');
        }
    });

</script>
</body>
</html>
